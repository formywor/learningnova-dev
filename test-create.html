<!doctype html>
<meta charset="utf-8"/>
<title>LearningNova – Test Create</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import { firebaseConfig } from "./firebase-config.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const sitename = "testsite123"; // change if already used

  function log(...a){ console.log("[test]", ...a); document.body.insertAdjacentHTML("beforeend", `<pre>${a.map(x=>typeof x==='object'?JSON.stringify(x):x).join(" ")}</pre>`); }

  onAuthStateChanged(auth, async (user)=>{
    if (!user) {
      log("Not signed in → opening Google popup…");
      await signInWithPopup(auth, new GoogleAuthProvider());
      return;
    }
    try {
      await user.getIdToken(true);
      log("UID:", user.uid, "Creating:", sitename);

      await setDoc(doc(db,"sites", sitename), {
        ownerUid: user.uid,      // MUST match rules
        published: false,        // MUST be false on create
        title: "Test Site",
        updatedAt: serverTimestamp(),
        pages: { home: { title: "Home", blocks: [ { id:"b1", type:"text", html:"<h1>Hello</h1>" } ] } }
      });

      log("SUCCESS! Created sites/" + sitename);
    } catch(e) {
      log("ERROR:", e.message || e.code || e);
      console.error(e);
    }
  });
</script>
<body style="font-family:ui-monospace,Menlo,monospace;color:#eaf2ff;background:#0b1220">
  <h2>Test Create</h2>
  <p>This page will sign in (Google popup) and try to create <code>sites/testsite123</code>.</p>
</body>
